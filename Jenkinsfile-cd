pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: gcloud
    image: google/cloud-sdk:latest   # Includes gcloud + kubectl
    command: ["cat"]
    tty: true
  """
        }
    }
    stages {
        stage('Clone repository') {
            steps {
                container('gcloud') {
                    script {
                        def repoUrl = 'https://github.com/venkat0007/simple-nodejs-app.git'
                        def branchName = 'main'
                        checkout([$class: 'GitSCM',
                                  branches: [[name: "refs/heads/${branchName}"]],
                                  userRemoteConfigs: [[url: repoUrl]]])
                    }
                }
            }
        }

        stage('Authenticate with GCP') {
            steps {
                container('gcloud') {
                    script {
                        // If 'gcp-sa-key' is a Secret Text credential
                        withCredentials([string(credentialsId: 'gcp-sa-key', variable: 'GCP_KEY_JSON')]) {
                            writeFile file: 'creds.json', text: "${GCP_KEY_JSON}"
                            sh """
                               
                                gcloud auth activate-service-account --key-file=creds.json
                                gcloud config set project test-468900
                                gcloud container clusters get-credentials cluster-1 \
                                    --zone us-central1-a --project test-468900
                            """
                        }
                    }
                }
            }
        }


        stage("Deploy to GKE") {
            steps {
                container('gcloud') {
                    script {
                        // Example: apply manifests from repo
                        sh """
                            kubectl apply -f deployment.yaml
                            kubectl apply -f service.yaml
                        """
                    }
                }
            }
        }
    }
}